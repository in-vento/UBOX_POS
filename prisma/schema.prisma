// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(cuid())
  name                String
  email               String?  @unique
  role                String // "Admin", "Mozo", "Cajero", "Barman", "Jefe"
  status              String   @default("Active") // "Active", "Inactive"
  pin                 String?
  password            String? // For Monitor role login
  phone               String?
  avatarUrl           String?
  commission          Float?
  failedLoginAttempts Int      @default(0)
  isLocked            Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  logs                Log[]
  orders              Order[]  @relation("WaiterOrders")
}

model MonitorConfig {
  id                  String   @id @default("default")
  isActive            Boolean  @default(true)
  popupDuration       Int      @default(3000) // in milliseconds
  soundEnabled        Boolean  @default(true)
  localAccessOnly     Boolean  @default(false)
  showDashboard       Boolean  @default(true)
  publicAccessEnabled Boolean  @default(false)
  publicUrl           String?
  updatedAt           DateTime @updatedAt
}

model SystemConfig {
  id          String   @id @default("default")
  cloudToken  String?
  businessId  String?
  fingerprint String?
  updatedAt   DateTime @updatedAt
}

model AppConfig {
  id                      String   @id @default("default")
  masajistaRoleName       String   @default("Masajista")
  masajistaRoleNamePlural String   @default("Masajistas")
  updatedAt               DateTime @updatedAt
}

model Product {
  id                   String      @id @default(cuid())
  name                 String
  price                Float
  category             String // 'Bebida', 'Comida', 'Servicio', 'Otro'
  stock                Int         @default(0)
  isCommissionable     Boolean     @default(false)
  commissionPercentage Float       @default(0)
  isCombo              Boolean     @default(false)
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  orderItems           OrderItem[]
  comboItems           ComboItem[] @relation("ComboToItems")
  usedInCombos         ComboItem[] @relation("ProductToCombos")
}

model ComboItem {
  id        String  @id @default(cuid())
  comboId   String
  combo     Product @relation("ComboToItems", fields: [comboId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation("ProductToCombos", fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int     @default(1)
}

model Order {
  id             String          @id @default(cuid())
  customId       String?         @unique // Custom ID format: XX-NNNNNN (e.g., JU-000001)
  waiterId       String?
  waiter         User?           @relation("WaiterOrders", fields: [waiterId], references: [id])
  customer       String          @default("Cliente General")
  status         String          @default("Pending") // 'Pending', 'Completed', 'Cancelled'
  totalAmount    Float           @default(0)
  paidAmount     Float           @default(0)
  masajistaIds   String? // JSON array of masajista IDs
  editedBy       String? // Name of the admin who last edited or cancelled the order
  cancelReason   String? // Reason why the order was cancelled
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  items          OrderItem[]
  payments       Payment[]
  sunatDocuments SunatDocument[]
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float // Price at the time of order
}

model Payment {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount    Float
  method    String // 'Efectivo', 'Yape / Plin', 'Tarjeta'
  cashier   String? // Name of the cashier who processed the payment
  timestamp DateTime @default(now())
}

model Log {
  id        String   @id @default(cuid())
  action    String
  details   String?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  timestamp DateTime @default(now())
}

model OrderCounter {
  id    String @id @default(cuid())
  date  String @unique // Format: YYYY-MM-DD
  count Int    @default(0)
}

model Printer {
  id        String   @id @default(cuid())
  name      String
  ip        String
  areas     String // JSON array: ["Caja", "Barra", "Cocina"]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SyncQueue {
  id        String   @id @default(cuid())
  entity    String // 'Order', 'Payment', 'Product', etc.
  entityId  String // The local ID of the entity
  action    String // 'CREATE', 'UPDATE', 'DELETE'
  payload   String // JSON stringified data to sync
  status    String   @default("PENDING") // 'PENDING', 'SYNCED', 'FAILED'
  attempts  Int      @default(0)
  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("sync_queue")
}

// ============================================
// SUNAT Electronic Billing Models
// ============================================

model Client {
  id          String          @id @default(cuid())
  tipoDoc     String // "DNI" | "RUC" | "CE" | "PASAPORTE"
  numDoc      String          @unique
  razonSocial String // Nombre completo o Razón Social
  direccion   String?
  email       String?
  telefono    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  documents   SunatDocument[]
}

model SunatDocument {
  id           String              @id @default(cuid())
  orderId      String
  order        Order               @relation(fields: [orderId], references: [id])
  clientId     String?
  client       Client?             @relation(fields: [clientId], references: [id])
  documentType String // "01" Factura, "03" Boleta, "07" Nota Crédito, "08" Nota Débito
  serie        String // e.g., "F001", "B001"
  correlativo  Int
  fullNumber   String // e.g., "F001-00000123"
  fechaEmision DateTime            @default(now())
  moneda       String              @default("PEN")
  subtotal     Float
  igv          Float
  total        Float
  status       String              @default("DRAFT") // DRAFT | ENVIADO | ACEPTADO | RECHAZADO | PENDIENTE
  provider     String? // "nubefact" | "efact" | "bizlinks" | "digiflow" | "mock"
  hash         String?
  pdfUrl       String?
  xmlUrl       String?
  cdrUrl       String?
  errorMessage String?
  retryCount   Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  items        SunatDocumentItem[]

  @@index([orderId])
  @@index([status])
}

model SunatDocumentItem {
  id             String        @id @default(cuid())
  documentId     String
  document       SunatDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  descripcion    String
  cantidad       Float
  valorUnitario  Float // Precio sin IGV
  precioUnitario Float // Precio con IGV
  igv            Float
  total          Float
}

model CompanySunatConfig {
  id                 String   @id @default("default")
  sunatEnabled       Boolean  @default(false)
  provider           String   @default("mock") // "mock" | "nubefact" | "efact" | etc.
  ruc                String?
  razonSocial        String?
  nombreComercial    String?
  direccion          String?
  ubigeo             String?
  departamento       String?
  provincia          String?
  distrito           String?
  regimen            String? // "GENERAL" | "MYPE" | "RER"
  serieFactura       String   @default("F001")
  serieBoleta        String   @default("B001")
  correlativoFactura Int      @default(0)
  correlativoBoleta  Int      @default(0)
  pseToken           String? // Encrypted
  pseUrl             String?
  pseRucUsuario      String? // For Nubefact
  updatedAt          DateTime @updatedAt
}
